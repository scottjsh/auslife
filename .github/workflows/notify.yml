name: notify

on:
  push:
    branches:
      - main

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: check commit
        uses: actions/checkout@v3

      - name: check commit message
        id: extract
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "ì»¤ë°‹ ë©”ì‹œì§€: $COMMIT_MSG"

          if [[ "$COMMIT_MSG" =~ ^Create\ ([0-9]{4})-([0-9]{2})-([0-9]{2})-([0-9]{4})\.md$ ]]; then
            TYPE="í—¤í—¤... ìƒˆ ê¸€ ì˜¬ë¼ì™”ì–´! ğŸ©·"
            NNNN="${BASH_REMATCH[4]}"
          elif [[ "$COMMIT_MSG" =~ ^Update\ ([0-9]{4})-([0-9]{2})-([0-9]{2})-([0-9]{4})\.md$ ]]; then
            TYPE="ê¸€ ì‚´ì§ ê³ ì³¤ì–´! ë” ì˜ˆë»ì¡Œì„ê±¸? âœ¨"
            NNNN="${BASH_REMATCH[4]}"
          else
            echo "ìŒ... ì´ê±´ ë¸”ë¡œê·¸ ê¸€ì´ ì•„ë‹Œ ê²ƒ ê°™ì•„! ğŸ™ˆ"
            echo "send=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          BLOG_URL="https://whitesky.kr/auslife/blog/$NNNN"
          echo "send=true" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "url=$BLOG_URL" >> $GITHUB_OUTPUT
          echo "id=$NNNN" >> $GITHUB_OUTPUT

      - name: send discord
        if: steps.extract.outputs.send == 'true'
        run: |
          echo "ìŒ... 1ë¶„ ì •ë„ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì¡°ì‹¬íˆ ì „í• ê²Œìš” ğŸ•’"
          sleep 60
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"${{ steps.extract.outputs.type }}"'",
                "description": "ğŸŒ· [ëˆ„ë¥´ë©´ ë°”ë¡œ ë³¼ ìˆ˜ ìˆì–´! í´ë¦­í´ë¦­ âœ¨](${{ steps.extract.outputs.url }})",
                "color": 15418782,
                "footer": {
                  "text": "ê¸€ ë²ˆí˜¸ëŠ” #${{ steps.extract.outputs.id }} ğŸ’—"
                },
                "timestamp": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"
              }]
            }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
